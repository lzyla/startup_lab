{% extends "base.html" %}
{% load static %}
{% block title %}Rozmowa z {{ character.name }}{% endblock %}

{% block content %}
<section class="chat-fullscreen">
  <div class="container-fluid h-100 d-flex align-items-center justify-content-center">
    <div class="card h-100 d-flex flex-column">

      <!-- Header -->
      <div class="card-header d-flex align-items-center gap-2 text-white rounded-top">
        <a href="/" class="text-white"><i class="fas fa-arrow-left"></i></a>
        
        {% if character.display_avatar %}
          <img src="{{ character.display_avatar }}" onerror="this.onerror=null;this.src='{% static 'img/default-avatar.png' %}';" alt="avatar" class="rounded-circle">
        {% else %}
          <img src="{% static 'img/default-avatar.png' %}" alt="avatar" class="rounded-circle">
        {% endif %}
      
        <div class="text-start">
          <h6 class="mb-0">{{ character.name }}</h6>
          <p class="mb-0 small fw-normal">{{ character.header_description|truncatewords:20 }}</p>
        </div>
      </div>

      <!-- Body -->
      <div class="card-body" id="chat-body">
        <div id="messages">
          {% for message in messages %}
            <div id="message-{{ forloop.counter }}">
              {% if message.is_user %}
                <div class="d-flex flex-row justify-content-end mb-4 pt-1 chat-row">
                  <div class="chat-bubble user newest">{{ message.content }}</div>
                </div>
              {% else %}
              <div class="d-flex flex-row justify-content-start ms-2 mb-4 pt-1 chat-row">
                {% if character.display_avatar %}
                  <img src="{{ character.display_avatar }}"
                       onerror="this.onerror=null;this.src='{% static 'img/default-avatar.png' %}';"
                       class="rounded-circle me-2 chat-avatar"
                       style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                  <img src="{% static 'img/default-avatar.png' %}"
                       class="rounded-circle me-2 chat-avatar"
                       style="width: 60px; height: 60px; object-fit: cover;">
                {% endif %}
                <div class="chat-bubble ai newest d-flex flex-column">
                  {% if forloop.last and message.is_typing %}
                    <span class="typing-text m-0 p-0" data-content="{{ message.content|escapejs }}"></span>
                    <div class="typing-indicator d-flex align-items-center mt-1" style="gap: 4px;">
                      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                  {% else %}
                    <div class="compact-content m-0 p-0">{{ message.content }}</div>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>
          {% endfor %}
          <div id="scroll-anchor"></div>
        </div>
      </div>

      <!-- Footer -->
      <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
        <form method="post" class="w-100 d-flex align-items-center">
          {% csrf_token %}
          <input type="hidden" name="conversation_id" value="{{ conversation_id }}">
          <input type="hidden" name="character_id" value="{{ character.id }}">
          <input name="content" type="text" class="form-control" placeholder="Rozpocznij rozmowę">
          <button class="btn btn-primary ms-2" type="submit">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</section>
<script>
const DEFAULT_AVATAR_URL = "{% static 'img/default-avatar.png' %}";
const CHARACTER_AVATAR_URL = "{{ character.display_avatar|default_if_none:''|escapejs }}";
const RESOLVED_AVATAR_URL = CHARACTER_AVATAR_URL || DEFAULT_AVATAR_URL;
const CONVERSATION_ID = "{{ conversation_id }}";

    // Scroll the new message into view
    function scrollToMessage(messageElem) {
      if (!messageElem) return;
      messageElem.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Wyświetlanie wiadomości użytkownika
    function displayUserMessage(text) {
      const messagesContainer = document.getElementById("messages");
      if (!messagesContainer) return;
    
      const messageWrapper = document.createElement("div");
      messageWrapper.innerHTML = `
        <div class="d-flex flex-row justify-content-end mb-4 pt-1 chat-row">
          <div class="chat-bubble user animated-chat-bubble">${text}</div>
        </div>
      `;
      messagesContainer.appendChild(messageWrapper);
      scrollToMessage(messageWrapper);
    }
    
    // Wyświetlanie wiadomości GPT z efektem pisania i przewijaniem w trakcie
    async function displayGPTResponse(text) {
        const messagesContainer = document.getElementById("messages");
        const chatBody = document.getElementById("chat-body");
        if (!messagesContainer || !chatBody) return;

        const messageWrapper = document.createElement("div");
        messageWrapper.innerHTML = `
            <div class="d-flex flex-row justify-content-start ms-2 mb-4 pt-1 chat-row">
                <img src="${RESOLVED_AVATAR_URL}" class="rounded-circle me-2 ai-avatar" style="width: 60px; height: 60px; object-fit: cover;">
                <div class="chat-bubble ai"></div>
            </div>
        `;
        messagesContainer.appendChild(messageWrapper);

        const bubble = messageWrapper.querySelector(".chat-bubble.ai");
        const avatarImg = messageWrapper.querySelector(".ai-avatar");
        if (avatarImg) {
            avatarImg.onerror = function () {
                this.onerror = null;
                this.src = DEFAULT_AVATAR_URL;
            };
        }

        for (let char of text) {
            bubble.textContent += char;
            chatBody.scrollTop = chatBody.scrollHeight; //widoczność
            await new Promise(resolve => setTimeout(resolve, 20)); // szybsze pisanie
        }
    }
    
    // Obsługa rozmowy
    async function onUserMessageSend(text) {
      if (text === "") return;
      displayUserMessage(text);
      const gptResponse = await generateGPTResponse(text);
      await displayGPTResponse(gptResponse);
    }
    
    // Obsługa formularza
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("form");
        const chatInput = form.querySelector("input[name='content']");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;

            displayUserMessage(text);
            if (!chatInput.dataset.placeholderCleared) {
                chatInput.placeholder = "";
                chatInput.dataset.placeholderCleared = "true";
            }
            chatInput.value = "";

            const dots = document.querySelector(".typing-indicator");
            if (dots) dots.classList.add("visible");

            try {
            const res = await fetch("/api/chat/", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                character_id: "{{ character.id }}",
                conversation_id: CONVERSATION_ID,
                message: text
                })
            });
            if (!res.ok) {
                console.error("Błąd API:", res.status);
                if (dots) dots.classList.remove("visible");
                return;
            }
            const data = await res.json();
            if (dots) dots.classList.remove("visible");
            await displayGPTResponse(data.response);
            } catch (error) {
            console.error("Błąd API:", error);
            if (dots) dots.classList.remove("visible");
            }
        });

        requestAnimationFrame(() => {
            setTimeout(() => {
            const chatBody = document.getElementById("chat-body");
            if (chatBody) {
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            document.querySelectorAll('.chat-bubble.newest').forEach(bubble => {
                bubble.classList.remove('newest');
            });
            }, 100);
        });
    });
  
    window.onload = () => {
        setTimeout(() => {
            const chatBody = document.getElementById("chat-body");
            if (chatBody) {
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }, 300);

        document.querySelectorAll('.chat-bubble.newest').forEach(bubble => {
            bubble.classList.remove('newest');
        });
    };
    </script>
    {% endblock %}
